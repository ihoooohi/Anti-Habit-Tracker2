// // entry/src/main/ets/pages/AchievementPage.ets
//
// import router from '@ohos.router';
// import { Achievement } from '../model/Achievement';
// import { AntiHabit } from '../model/AntiHabit';
// import { ALL_ACHIEVEMENTS } from '../util/AchievementList';
// // ÂÆö‰πâË∑ØÁî±ÂèÇÊï∞Á±ªÂûãÊé•Âè£
// interface RouteParams {
//   habit: AntiHabit;
// }
//
// @Entry
// @Component
// struct AchievementPage {
//   // ËøôÊ†∑ÂèØ‰ª•ÈÅøÂÖçÂú®ÊûÑÈÄ†ÂáΩÊï∞‰∏≠Á´ãÂç≥ËÆøÈóÆË∑ØÁî±ÂèÇÊï∞
//   @State habit: AntiHabit | null = null;
//   aboutToAppear() {
//     const params = router.getParams() as RouteParams;
//     if (params && params.habit) {
//       // ‰ªéÂ∫èÂàóÂåñÁöÑÊï∞ÊçÆ‰∏≠ÈáçÂª∫ AntiHabit ÂØπË±°
//       this.habit = AntiHabit.fromJSON(params.habit);
//     } else {
//       console.error('AchievementPage: Failed to get habit from router params.');
//       // ÂèØ‰ª•Âú®ËøôÈáåÂ§ÑÁêÜÈîôËØØÔºåÊØîÂ¶ÇËøîÂõû‰∏ä‰∏ÄÈ°µÊàñÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
//       router.back();
//     }
//   }
//
//   build() {
//     // Á°Æ‰øù this.habit ‰∏çÊòØ null Êó∂ÊâçÊ∏≤ÊüìUIÔºåÈò≤Ê≠¢Êä•Èîô
//     if (this.habit) {
//
//       Column() {
//         // 1. Ëá™ÂÆö‰πâÊ†áÈ¢òÊ†èÔºåÂåÖÂê´ËøîÂõûÊåâÈíÆÂíåÊ†áÈ¢ò
//         Row() {
//           // ËøîÂõûÊåâÈíÆ
//           Image($r('app.media.ic_back')) // ËØ∑Á°Æ‰øù‰Ω†ÊúâÂêç‰∏∫ic_back.xmlÁöÑËøîÂõûÂõæÊ†á
//             .width(60).height(60)
//             .padding(15)
//             .objectFit(ImageFit.Contain)
//             // ‚≠ê Ëß£ÂÜ≥ÊñπÊ°à‰∫åÔºöÊ∑ªÂä†‰∏Ä‰∏™Áúã‰∏çËßÅÁöÑËÉåÊôØËâ≤
//             .backgroundColor(Color.Transparent)
//             .onClick(()=> {
//               router.back();
//             })
//
//           // È°µÈù¢Ê†áÈ¢ò
//           Text(`"${this.habit.name}" ÊàêÂ∞±ÊÆøÂ†Ç`)
//             .fontSize(20)
//             .fontWeight(FontWeight.Bold)
//             .layoutWeight(1)
//             .textAlign(TextAlign.Center)
//             .margin({ left: -32 }) // Ë¥ümarginËÆ©Ê†áÈ¢òÂú®ËßÜËßâ‰∏äÊõ¥Â±Ö‰∏≠
//
//           // ‰ΩøÁî® Blank ÁªÑ‰ª∂Âç†‰ΩçÔºåÂ∏ÆÂä©Ê†áÈ¢òÂ±Ö‰∏≠
//           Blank().width(24)
//         }
//         .width('100%')
//         .height(56) // Ê†áÂáÜÊ†áÈ¢òÊ†èÈ´òÂ∫¶
//         .padding({ left: 10, right: 10 })
//         .backgroundColor(Color.White)
//         .shadow({ radius: 3, color: '#1F000000' })
//
//
//         // 2. ‰ΩøÁî® Grid ÁΩëÊ†ºÂ∏ÉÂ±ÄÊù•Â±ïÁ§∫ÊâÄÊúâÂæΩÁ´†
//         Grid() {
//           ForEach(ALL_ACHIEVEMENTS, (achieve: Achievement) => {
//             GridItem() {
//               Column({ space: 8 }) {
//                 // Âú® build ÂáΩÊï∞ÂÜÖÈÉ®Ôºå‰ΩøÁî® $r() Âä†ËΩΩËµÑÊ∫êË∑ØÂæÑÂ≠óÁ¨¶‰∏≤
//                 Image($r(achieve.icon))
//                   .width(80).height(80)
//                 // Ê†πÊçÆÊàêÂ∞±ÊòØÂê¶Â∑≤Ëß£ÈîÅÔºåÂä®ÊÄÅËÆæÁΩÆÁÅ∞Â∫¶ÂíåÈÄèÊòéÂ∫¶
//                   .grayscale(this.habit!.unlockedAchievements.includes(achieve.id) ? 0 : 1)
//                   .opacity(this.habit!.unlockedAchievements.includes(achieve.id) ? 1 : 0.6)
//
//                 Text(achieve.name)
//                   .fontSize(16).fontWeight(FontWeight.Bold)
//                 Text(achieve.description)
//                   .fontSize(12).fontColor(Color.Gray)
//                   .textAlign(TextAlign.Center)
//                   .margin({ top: 4 })
//               }
//               .padding(10)
//               .alignItems(HorizontalAlign.Center)
//             }
//           })
//         }
//         .columnsTemplate('1fr 1fr') // ÊØèË°åÊòæÁ§∫2‰∏™ÂæΩÁ´†
//         .rowsGap(15)
//         .columnsGap(15)
//         .padding(15)
//         .layoutWeight(1) // Âç†ÊçÆÂâ©‰ΩôÊâÄÊúâÁ©∫Èó¥
//
//       }
//       .width('100%').height('100%').backgroundColor('#F1F3F5')
//     }
//   }
// }
//
//
import router from '@ohos.router';
import { Achievement } from '../model/Achievement';
import { AntiHabit } from '../model/AntiHabit';
import { ALL_ACHIEVEMENTS } from '../util/AchievementList';
import { calculateDaysBetween } from '../util/DateUtil';

interface RouteParams {
  habit: AntiHabit;
}

// Ê∑ªÂä†ËæπÊ°ÜÊ†∑ÂºèÊé•Âè£ÂÆö‰πâ
interface BorderConfig {
  width: number;
  color: string;
  style: BorderStyle;
}

@Entry
@Component
struct AchievementPage {
  @State habit: AntiHabit | null = null;
  @State unlockedCount: number = 0;
  @State totalCount: number = 0;
  @State currentDays: number = 0;

  aboutToAppear() {
    const params = router.getParams() as RouteParams;
    if (params && params.habit) {
      this.habit = AntiHabit.fromJSON(params.habit);
      this.calculateStats();
    } else {
      console.error('AchievementPage: Failed to get habit from router params.');
      router.back();
    }
  }

  private calculateStats() {
    if (this.habit) {
      this.unlockedCount = this.habit.unlockedAchievements.length;
      this.totalCount = ALL_ACHIEVEMENTS.length;
      this.currentDays = calculateDaysBetween(this.habit.lastBreakDate, new Date());
    }
  }

  // Ëé∑ÂèñÊàêÂ∞±Áä∂ÊÄÅÈ¢úËâ≤
  private getAchievementColor(achievement: Achievement): string {
    if (this.habit?.unlockedAchievements.includes(achievement.id)) {
      return '#4CAF50'; // Â∑≤Ëß£ÈîÅÔºöÁªøËâ≤
    }
    return '#E0E0E0'; // Êú™Ëß£ÈîÅÔºöÁÅ∞Ëâ≤
  }

  // ‰øÆÂ§çÔºö‰ΩøÁî®ÊòéÁ°ÆÁöÑËøîÂõûÁ±ªÂûã
  private getAchievementBorder(achievement: Achievement): BorderConfig {
    if (this.habit?.unlockedAchievements.includes(achievement.id)) {
      const unlockedBorder: BorderConfig = {
        width: 3,
        color: '#4CAF50',
        style: BorderStyle.Solid
      };
      return unlockedBorder;
    }

    const lockedBorder: BorderConfig = {
      width: 2,
      color: '#E0E0E0',
      style: BorderStyle.Dashed
    };
    return lockedBorder;
  }

  @Builder
  StatsHeader() {
    Column({ space: 15 }) {
      // ‰π†ÊÉØÂêçÁß∞ÂíåÂ§©Êï∞
      Column({ space: 10 }) {
        Text(`"${this.habit?.name}"`)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .textAlign(TextAlign.Center)

        Row({ space: 10 }) {
          Text('Â∑≤ÂùöÊåÅ')
            .fontSize(16)
            .fontColor('#666')

          Text(`${this.currentDays}`)
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B35')

          Text('Â§©')
            .fontSize(16)
            .fontColor('#666')
        }
        .justifyContent(FlexAlign.Center)
      }

      // ÊàêÂ∞±ËøõÂ∫¶Êù°
      Column({ space: 8 }) {
        Row() {
          Text('ÊàêÂ∞±ËøõÂ∫¶')
            .fontSize(14)
            .fontColor('#666')

          Blank()

          Text(`${this.unlockedCount}/${this.totalCount}`)
            .fontSize(14)
            .fontColor('#666')
        }
        .width('100%')

        // ËøõÂ∫¶Êù°
        Progress({
          value: this.unlockedCount,
          total: this.totalCount,
          type: ProgressType.Linear
        })
          .width('100%')
          .height(8)
          .color('#4CAF50')
          .backgroundColor('#E8F5E8')
          .borderRadius(4)
      }
      .width('100%')
    }
    .width('90%')
    .padding(25)
    .backgroundColor(Color.White)
    .borderRadius(15)
    .shadow({ radius: 8, color: '#1F000000', offsetY: 4 })
    .margin({ top: 20, bottom: 20 })
  }

  build() {
    if (this.habit) {
      Column() {
        // ÊîπËøõÁöÑÊ†áÈ¢òÊ†è
        Row() {
          Button({ type: ButtonType.Circle }) {
            Text('‚Üê')
              .fontSize(20)
              .fontColor('#333')
          }
          .width(40)
          .height(40)
          .backgroundColor('#F5F5F5')
          .onClick(() => {
            router.back();
          })

          Text('ÊàêÂ∞±ÊÆøÂ†Ç')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
            .fontColor('#333')

          // Âç†‰ΩçÁ¨¶‰øùÊåÅÊ†áÈ¢òÂ±Ö‰∏≠
          Blank().width(40)
        }
        .width('100%')
        .height(60)
        .padding({ left: 15, right: 15 })
        .backgroundColor(Color.White)
        .shadow({ radius: 4, color: '#1F000000', offsetY: 2 })

        // ÊªöÂä®ÂÜÖÂÆπ
        Scroll() {
          Column() {
            // ÁªüËÆ°Â§¥ÈÉ®
            this.StatsHeader()

            // ÊàêÂ∞±ÂàÜÁ±ªÊ†áÈ¢ò
            Text('üèÜ ÂÖ®ÈÉ®ÊàêÂ∞±')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .width('90%')
              .margin({ bottom: 15 })

            // ÊîπËøõÁöÑÊàêÂ∞±ÁΩëÊ†º
            Grid() {
              ForEach(ALL_ACHIEVEMENTS, (achievement: Achievement, index: number) => {
                GridItem() {
                  Column({ space: 12 }) {
                    // ÊàêÂ∞±ÂõæÊ†áÂÆπÂô®
                    Stack() {
                      // ËÉåÊôØÂúÜÂúà
                      Circle()
                        .width(80)
                        .height(80)
                        .fill(this.getAchievementColor(achievement))
                        .opacity(0.1)

                      // ÊàêÂ∞±ÂõæÊ†á
                      Image($r(achievement.icon))
                        .width(50)
                        .height(50)
                        .grayscale(this.habit!.unlockedAchievements.includes(achievement.id) ? 0 : 1)
                        .opacity(this.habit!.unlockedAchievements.includes(achievement.id) ? 1 : 0.4)

                      // // Â∑≤Ëß£ÈîÅÂæΩÁ´†
                      // if (this.habit!.unlockedAchievements.includes(achievement.id)) {
                      //   Text('‚úì')
                      //     .fontSize(16)
                      //     .fontColor('#4CAF50')
                      //     .backgroundColor(Color.White)
                      //     .border({ color: '#4CAF50' })  // ÁªøËâ≤ËæπÊ°Ü
                      //     .width(24)
                      //     .height(24)
                      //     .borderRadius(12)
                      //     .textAlign(TextAlign.Center)
                      //     .position({ x: 60, y: 5 })
                      // }
                    }
                    .border(this.getAchievementBorder(achievement))
                    .borderRadius(40)

                    // ÊàêÂ∞±‰ø°ÊÅØ
                    Column({ space: 4 }) {
                      Text(achievement.name)
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor(this.habit!.unlockedAchievements.includes(achievement.id) ? '#333' : '#999')
                        .textAlign(TextAlign.Center)
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })

                      Text(achievement.description)
                        .fontSize(12)
                        .fontColor(this.habit!.unlockedAchievements.includes(achievement.id) ? '#666' : '#BBB')
                        .textAlign(TextAlign.Center)
                        .maxLines(2)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                        .lineHeight(16)
                    }
                    .width('100%')
                  }
                  .padding(15)
                  .backgroundColor(Color.White)
                  .borderRadius(12)
                  .shadow({
                    radius: this.habit!.unlockedAchievements.includes(achievement.id) ? 8 : 4,
                    color: '#1A000000',
                    offsetY: this.habit!.unlockedAchievements.includes(achievement.id) ? 4 : 2
                  })
                  .alignItems(HorizontalAlign.Center)
                  // Ê∑ªÂä†ÁÇπÂáªÂä®ÁîªÊïàÊûú
                  .animation({
                    duration: 200,
                    curve: Curve.EaseInOut
                  })
                }
              })
            }
            .columnsTemplate('1fr 1fr')
            .rowsGap(15)
            .columnsGap(15)
            .width('90%')
            .margin({ bottom: 30 })
          }
          .alignItems(HorizontalAlign.Center)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)

      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F8F9FA')
    }
  }
}