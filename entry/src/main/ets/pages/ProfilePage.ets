// entry/src/main/ets/pages/ProfilePage.ets
import common from '@ohos.app.ability.common';
import { AntiHabit } from '../model/AntiHabit';
import { calculateDaysBetween } from '../util/DateUtil';
import { habitStorage } from '../util/HabitStorage';
import { eventBus } from '../util/eventBus';
import { router } from '@kit.ArkUI';
import { profileStorage, ProfileInfo } from '../util/ProfileStorage';

// å®šä¹‰äº‹ä»¶æ•°æ®ç±»å‹
interface ProfileUpdateEvent {
  avatarUri?: string;
  nickname?: string;
  signature?: string;
}

@Entry
@Component
export struct ProfilePage {
  @State totalDays: number = 0;
  @State longestStreak: number = 0;
  @State totalAchievements: number = 0;
  @State updateTrigger: number = 0; // ç”¨äºå¼ºåˆ¶UIæ›´æ–°

  @State avatarUri: string = '';
  @State nickname: string = 'åä¹ æƒ¯è¾¾äºº'; // ç”¨æˆ·å
  @State signature: string = 'æ—¥å¤ä¸€æ—¥ï¼ŒåŠŸä¸å”æ'; // ä¸ªæ€§ç­¾å

  private context: common.UIAbilityContext | null = null;
  // æ·»åŠ äº‹ä»¶å›è°ƒå¼•ç”¨
  private habitsUpdatedCallback: () => void = () => {};
  private profileUpdatedCallback: (data: ProfileUpdateEvent) => void = () => {};

  aboutToAppear() {
    this.context = getContext(this) as common.UIAbilityContext;
    this.loadAndCalculateStats();

    if (this.context) {
      profileStorage.loadProfile(this.context).then((profile: ProfileInfo) => {
        this.avatarUri = profile.avatarUri;
        this.nickname = profile.nickname;
        this.signature = profile.signature;
      });
    }

    // ç›‘å¬ä¹ æƒ¯æ›´æ–°äº‹ä»¶
    this.habitsUpdatedCallback = () => {
      setTimeout(() => {
        this.loadAndCalculateStats();
      }, 100);
    };
    eventBus.on('habitsUpdated', this.habitsUpdatedCallback);

    // ç›‘å¬ä¸ªäººèµ„æ–™æ›´æ–°
    this.profileUpdatedCallback = (data: ProfileUpdateEvent) => {
      if (data.avatarUri !== undefined) this.avatarUri = data.avatarUri;
      if (data.nickname !== undefined) this.nickname = data.nickname;
      if (data.signature !== undefined) this.signature = data.signature;
    };
    eventBus.on('profileUpdated', this.profileUpdatedCallback);
  }

  // é¡µé¢å³å°†æ¶ˆå¤±æ—¶å–æ¶ˆè®¢é˜…
  aboutToDisappear() {
    eventBus.off('habitsUpdated', this.habitsUpdatedCallback);
    eventBus.off('profileUpdated', this.profileUpdatedCallback);
  }

  // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®
  onPageShow() {
    if (this.context) {
      this.loadAndCalculateStats();

      // ä¿è¯é‡æ–°è¿›å…¥æ—¶èƒ½æ˜¾ç¤ºæœ€æ–°èµ„æ–™
      profileStorage.loadProfile(this.context).then((profile: ProfileInfo) => {
        this.avatarUri = profile.avatarUri;
        this.nickname = profile.nickname;
        this.signature = profile.signature;
      });
    }
  }

  loadAndCalculateStats() {
    if (!this.context) return;

    habitStorage.loadHabits(this.context).then(habits => {
      let total = 0;
      let longest = 0;
      let achievements = 0;

      habits.forEach(habit => {
        const currentStreak = calculateDaysBetween(habit.lastBreakDate, new Date());
        total += currentStreak;
        if (currentStreak > longest) {
          longest = currentStreak;
        }
        achievements += habit.unlockedAchievements.length;
      });

      // å…ˆæ¸…é›¶æ‰€æœ‰çŠ¶æ€ï¼Œç„¶åè®¾ç½®æ–°å€¼
      this.totalDays = 0;
      this.longestStreak = 0;
      this.totalAchievements = 0;
      this.updateTrigger++;

      // ä½¿ç”¨setTimeoutç¡®ä¿UIèƒ½æ­£ç¡®æ›´æ–°
      setTimeout(() => {
        this.totalDays = total;
        this.longestStreak = longest;
        this.totalAchievements = achievements;
        this.updateTrigger++;
      }, 10);
    }).catch((error: Error) => {
      console.error('ProfilePage: åŠ è½½ä¹ æƒ¯æ•°æ®å¤±è´¥', error);
    });
  }

  @Builder
  ProfileCard() {
    Row({ space: 15 }) {
      // å¤´åƒ
      Image(this.avatarUri ? this.avatarUri : $r('app.media.startIcon'))
        .width(60)
        .height(60)
        .borderRadius(30)
        .border({ width: 2, color: Color.White })

      // ç”¨æˆ·åå’Œç­¾å
      Column({ space: 5 }) {
        Text(this.nickname)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.Black)
        Text(this.signature)
          .fontSize(14)
          .fontColor(Color.Gray)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('90%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(15)
    .shadow({ radius: 8, color: '#1F000000', offsetY: 4 })
    .margin({ top: 20 })
    // ç‚¹å‡»è¿›å…¥ä¸ªäººèµ„æ–™é¡µé¢
    .onClick(() => {
      router.pushUrl({
        url: 'pages/EditProfilePage'
      });
    })
  }

  @Builder
  CoreStatsCard() {
    // é‡‡ç”¨ç«–å‘åˆ—è¡¨æ ·å¼ï¼Œæ›´ç®€æ´
    Column() {
      // ç›´æ¥ä½¿ç”¨Rowç»„ä»¶ç¡®ä¿çŠ¶æ€ç»‘å®šæ­£ç¡®
      Row({ space: 15 }) {
        Text('ğŸ“…')
          .fontSize(20)
          .width(24)
          .textAlign(TextAlign.Center)
        Text('æ€»åšæŒå¤©æ•°')
          .fontSize(16)
          .fontColor(Color.Black)
        Blank()
        Text(`${this.totalDays}å¤©`)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FF6B35')
      }
      .width('100%')
      .height(55)
      .padding({ left: 10, right: 10 })

      Divider().width('90%').color('#E0E0E0').margin({ left: '10%' })

      Row({ space: 15 }) {
        Text('ğŸ†')
          .fontSize(20)
          .width(24)
          .textAlign(TextAlign.Center)
        Text('æœ€é•¿å•é¡¹çºªå½•')
          .fontSize(16)
          .fontColor(Color.Black)
        Blank()
        Text(`${this.longestStreak}å¤©`)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FF6B35')
      }
      .width('100%')
      .height(55)
      .padding({ left: 10, right: 10 })

      Divider().width('90%').color('#E0E0E0').margin({ left: '10%' })

      Row({ space: 15 }) {
        Text('ğŸŒŸ')
          .fontSize(20)
          .width(24)
          .textAlign(TextAlign.Center)
        Text('å·²è§£é”æˆå°±')
          .fontSize(16)
          .fontColor(Color.Black)
        Blank()
        Text(`${this.totalAchievements}ä¸ª`)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FF6B35')
      }
      .width('100%')
      .height(55)
      .padding({ left: 10, right: 10 })
    }
    .width('90%')
    .padding({ left: 15, right: 15 })
    .backgroundColor(Color.White)
    .borderRadius(15)
    .margin({ top: 20 })
  }

  // å•ç‹¬å°è£…ä¸€ä¸ªBuilderç”¨äºç”Ÿæˆæ¯ä¸€è¡Œï¼Œæ–¹ä¾¿å¤ç”¨å’Œä¿®æ”¹
  @Builder
  StatsRow(icon: string, label: string, value: string) {
    Row({
      space: 15
    }) {
      Text(icon)
        .fontSize(20)
        .width(24)
        .textAlign(TextAlign.Center)

      Text(label)
        .fontSize(16)
        .fontColor(Color.Black)

      Blank()

      Text(value)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FF6B35')
    }
    .width('100%')
    .height(55)
    .padding({ left: 10, right: 10 })
  }

  build() {
    Column() {
      // é¡µé¢æ ‡é¢˜
      Text('æˆ‘çš„')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .width('90%')
        .textAlign(TextAlign.Start)
        .margin({ top: 20, bottom: 10 })

      // ä¸ªäººä¿¡æ¯å¡ç‰‡
      this.ProfileCard()

      // æ ¸å¿ƒæ•°æ®ç»Ÿè®¡
      this.CoreStatsCard()

      // å…¶ä»–å†…å®¹å¯ä»¥ä»è¿™é‡Œç»§ç»­æ·»åŠ 
      Blank() // å ä½ç¬¦ï¼Œç”¨äºå°†å†…å®¹æ¨åˆ°é¡¶éƒ¨

    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
    .alignItems(HorizontalAlign.Center)
  }
}
