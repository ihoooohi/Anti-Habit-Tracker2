// entry/src/main/ets/pages/ProfilePage.ets
import common from '@ohos.app.ability.common';
import { AntiHabit } from '../model/AntiHabit';
import { calculateDaysBetween } from '../util/DateUtil';
import { habitStorage } from '../util/HabitStorage';

@Entry
@Component
export struct ProfilePage {
  @State totalDays: number = 0;
  @State longestStreak: number = 0;
  @State totalAchievements: number = 0;

  private context: common.UIAbilityContext | null = null;

  aboutToAppear() {
    this.context = getContext(this) as common.UIAbilityContext;
    this.loadAndCalculateStats();
  }

  loadAndCalculateStats() {
    if (!this.context) return;

    habitStorage.loadHabits(this.context).then(habits => {
      let total = 0;
      let longest = 0;
      let achievements = 0;

      habits.forEach(habit => {
        const currentStreak = calculateDaysBetween(habit.lastBreakDate, new Date());
        total += currentStreak;
        if (currentStreak > longest) {
          longest = currentStreak;
        }
        achievements += habit.unlockedAchievements.length;
      });

      this.totalDays = total;
      this.longestStreak = longest;
      this.totalAchievements = achievements;
    });
  }

  @Builder
  ProfileCard() {
    Row({ space: 15 }) {
      // å¤´åƒ
      Image($r('app.media.startIcon'))
        .width(60)
        .height(60)
        .borderRadius(30)
        .border({ width: 2, color: Color.White })

      // ç”¨æˆ·åå’Œç­¾å
      Column({ space: 5 }) {
        Text('åä¹ æƒ¯è¾¾äºº')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.Black)
        Text('æ—¥å¤ä¸€æ—¥ï¼ŒåŠŸä¸å”æ')
          .fontSize(14)
          .fontColor(Color.Gray)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('90%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(15)
    .shadow({ radius: 8, color: '#1F000000', offsetY: 4 })
    .margin({ top: 20 })
  }

  @Builder
  CoreStatsCard() {
    // é‡‡ç”¨ç«–å‘åˆ—è¡¨æ ·å¼ï¼Œæ›´ç®€æ´
    Column() {
      // å°è£…æ¯ä¸ªç»Ÿè®¡é¡¹
      this.StatsRow('ğŸ“…', 'æ€»åšæŒå¤©æ•°', `${this.totalDays}`)
      Divider().width('90%').color('#E0E0E0').margin({ left: '10%' })
      this.StatsRow('ğŸ†', 'æœ€é•¿å•é¡¹çºªå½•', `${this.longestStreak}`)
      Divider().width('90%').color('#E0E0E0').margin({ left: '10%' })
      this.StatsRow('ğŸŒŸ', 'å·²è§£é”æˆå°±', `${this.totalAchievements}`)
    }
    .width('90%')
    .padding({ left: 15, right: 15 })
    .backgroundColor(Color.White)
    .borderRadius(15)
    .margin({ top: 20 })
  }

  // å•ç‹¬å°è£…ä¸€ä¸ªBuilderç”¨äºç”Ÿæˆæ¯ä¸€è¡Œï¼Œæ–¹ä¾¿å¤ç”¨å’Œä¿®æ”¹
  @Builder
  StatsRow(icon: string, label: string, value: string) {
    Row({
      space: 15
    }) {
      Text(icon)
        .fontSize(20)
        .width(24)
        .textAlign(TextAlign.Center)

      Text(label)
        .fontSize(16)
        .fontColor(Color.Black)

      Blank()

      Text(value)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FF6B35')
    }
    .width('100%')
    .height(55)
    .padding({ left: 10, right: 10 })
  }

  build() {
    Column() {
      // é¡µé¢æ ‡é¢˜
      Text('æˆ‘çš„')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .width('90%')
        .textAlign(TextAlign.Start)
        .margin({ top: 20, bottom: 10 })

      // ä¸ªäººä¿¡æ¯å¡ç‰‡
      this.ProfileCard()

      // æ ¸å¿ƒæ•°æ®ç»Ÿè®¡
      this.CoreStatsCard()

      // å…¶ä»–å†…å®¹å¯ä»¥ä»è¿™é‡Œç»§ç»­æ·»åŠ 
      Blank() // å ä½ç¬¦ï¼Œç”¨äºå°†å†…å®¹æ¨åˆ°é¡¶éƒ¨

    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
    .alignItems(HorizontalAlign.Center)
  }
}
