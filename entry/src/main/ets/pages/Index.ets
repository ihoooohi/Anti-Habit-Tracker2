import { AntiHabit, FailureLog } from '../model/AntiHabit';
import { calculateDaysBetween } from '../util/DateUtil';
import { AddHabitDialog } from '../view/AddHabitDialog';
import { habitStorage } from '../util/HabitStorage';
import common from '@ohos.app.ability.common';
import { achievementService } from '../util/AchievementService';
import router from '@ohos.router';
import { FailureLogDialog } from '../view/FailureLogDialog';
import { RecordsPage } from './RecordsPage'; // 1. å¯¼å…¥æ–°é¡µé¢
import { ProfilePage } from './ProfilePage'; // 1. å¯¼å…¥æ–°é¡µé¢
import { eventBus } from '../util/eventBus';

interface AchievementDialogParams {
  names: string[];
}

@Entry
@Component
struct Index {
  @State habits: AntiHabit[] = [];
  @State habitToDeleteId: number = -1; // æ”¹ä¸ºä½¿ç”¨IDè€Œä¸æ˜¯ç´¢å¼•
  @State newAchievementNames: string[] = [];
  @State totalDays: number = 0;
  @State todayProgress: number = 0;
  @State habitToResetId: number = -1; // ä¹Ÿæ”¹ä¸ºä½¿ç”¨ID
  @State currentTabIndex: number = 0; // ç”¨äºæ§åˆ¶å½“å‰é€‰ä¸­çš„Tab
  @State habitDays: number[] = []; // å­˜å‚¨æ¯ä¸ªä¹ æƒ¯çš„å½“å‰å¤©æ•°

  private context: common.UIAbilityContext | null = null;

  private failureLogDialogController: CustomDialogController = new CustomDialogController({
    builder: this.FailureLogDialogBuilder,
    autoCancel: true
  });

  @Builder
  private FailureLogDialogBuilder() {
    FailureLogDialog({
      controller: this.failureLogDialogController,
      onConfirm: (reason: string) => {
        if (this.habitToResetId !== -1) {
          this.logFailure(this.habitToResetId, reason);
        }
      }
    })
  }

  private deleteDialogController: CustomDialogController = new CustomDialogController({
    builder: this.DeleteConfirmDialog,
    autoCancel: true
  });

  private achievementDialogController: CustomDialogController = new CustomDialogController({
    builder: () => {
      this.AchievementUnlockedDialog({ names: this.newAchievementNames })
    },
    autoCancel: true,
    alignment: DialogAlignment.Center
  });

  @Builder
  private buildAddHabitDialog() {
    AddHabitDialog({
      controller: this.dialogController,
      onConfirm: (name: string) => {
        this.addNewHabit(name);
      }
    })
  }

  private dialogController: CustomDialogController = new CustomDialogController({
    builder: this.buildAddHabitDialog,
    autoCancel: true,
    alignment: DialogAlignment.Center
  });

  private calculateStats() {
    this.totalDays = this.habits.reduce((sum, habit) => {
      return sum + calculateDaysBetween(habit.lastBreakDate, new Date());
    }, 0);

    this.todayProgress = this.habits.length > 0 ?
    Math.round((this.habits.filter(h => calculateDaysBetween(h.lastBreakDate, new Date()) > 0).length / this.habits.length) * 100) : 0;
    
    // æ›´æ–°æ¯ä¸ªä¹ æƒ¯çš„å¤©æ•°
    this.updateHabitDays();
  }
  
  private updateHabitDays() {
    this.habitDays = this.habits.map(habit => calculateDaysBetween(habit.lastBreakDate, new Date()));
  }

  onPageShow() {
    this.context = getContext(this) as common.UIAbilityContext;
    habitStorage.loadHabits(this.context).then(loadedHabits => {
      let anyChange = false;
      let allNewNames: string[] = [];

      loadedHabits.forEach(habit => {
        const newlyUnlocked = achievementService.checkAndUnlock(habit);
        if (newlyUnlocked.length > 0) {
          anyChange = true;
          allNewNames.push(...newlyUnlocked);
        }
      });

      this.habits = loadedHabits;
      this.calculateStats();

      if (anyChange) {
        this.newAchievementNames = allNewNames;
        this.achievementDialogController.open();
        if (this.context) {
          habitStorage.saveHabits(this.context, this.habits);
        }
      }
      
      // æ— è®ºæ˜¯å¦æœ‰æˆå°±å˜åŒ–ï¼Œéƒ½é€šçŸ¥å…¶ä»–é¡µé¢åˆ·æ–°æ•°æ®
      // å› ä¸ºæ—¥æœŸå˜åŒ–å¯èƒ½å½±å“åšæŒå¤©æ•°è®¡ç®—
      eventBus.emit('habitsUpdated');
    })
  }

  resetHabit(habitId: number) {
    this.habitToResetId = habitId;
    this.failureLogDialogController.open();
  }

  async logFailure(habitId: number, reason: string) {
    if (!this.context || habitId === -1) {
      return;
    }

    const habitIndex = this.habits.findIndex(h => h.id === habitId);
    if (habitIndex === -1) {
      return; // æ‰¾ä¸åˆ°å¯¹åº”çš„ä¹ æƒ¯
    }

    const habitToUpdate = this.habits[habitIndex];
    const newLog: FailureLog = { date: new Date(), reason: reason };
    habitToUpdate.failureLogs.push(newLog);
    habitToUpdate.lastBreakDate = new Date();
    habitToUpdate.unlockedAchievements = [];
    
    // åˆ›å»ºæ–°çš„æ•°ç»„ä»¥è§¦å‘å“åº”å¼æ›´æ–°
    const updatedHabits = [...this.habits];
    updatedHabits[habitIndex] = AntiHabit.fromJSON(habitToUpdate.toJSON());
    this.habits = updatedHabits;
    
    await habitStorage.saveHabits(this.context, this.habits);
    this.calculateStats(); // è¿™ä¼šæ›´æ–° habitDays æ•°ç»„
    eventBus.emit('habitsUpdated'); // é€šçŸ¥å…¶ä»–é¡µé¢æ•°æ®å·²æ›´æ–°
  }

  async addNewHabit(name: string) {
    if (!this.context) return;
    const newId = new Date().getTime();
    const newHabit = new AntiHabit(newId, name, new Date());
    this.habits = [newHabit, ...this.habits]; // ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦åˆ›å»ºæ–°æ•°ç»„
    await habitStorage.saveHabits(this.context, this.habits);
    this.calculateStats();
    eventBus.emit('habitsUpdated'); // é€šçŸ¥å…¶ä»–é¡µé¢
  }

  async deleteHabit(habitId: number) {
    if (!this.context || habitId === -1) {
      return;
    }
    const initialLength = this.habits.length;
    this.habits = this.habits.filter(habit => habit.id !== habitId);
    
    // ç¡®è®¤åˆ é™¤æˆåŠŸ
    if (this.habits.length < initialLength) {
      await habitStorage.saveHabits(this.context, this.habits);
      this.calculateStats();
      eventBus.emit('habitsUpdated'); // é€šçŸ¥å…¶ä»–é¡µé¢
    }
  }

  private getDaysColor(days: number): string {
    if (days >= 30) return '#00C853';
    if (days >= 14) return '#4CAF50';
    if (days >= 7) return '#8BC34A';
    if (days >= 3) return '#FFC107';
    return '#FF5722';
  }

  private getBadgeText(days: number): string {
    if (days >= 30) return 'ğŸ’';
    if (days >= 14) return 'ğŸ†';
    if (days >= 7) return 'ğŸ¥‡';
    if (days >= 3) return 'ğŸ¥ˆ';
    return 'ğŸ¥‰';
  }

  @Builder AchievementUnlockedDialog(params: AchievementDialogParams) {  Column({ space: 20 }) {
    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
    Text('ğŸ‰')
      .fontSize(48)
      .animation({
        duration: 1000,
        curve: Curve.EaseInOut,
        iterations: -1,
        playMode: PlayMode.Alternate
      })

    Text('æ­å–œè§£é”æ–°æˆå°±ï¼')
      .fontSize(24)
      .fontWeight(FontWeight.Bold)
      .fontColor('#FF6B35')

    Text(`${params.names.join('ã€')}`)
      .fontSize(18)
      .textAlign(TextAlign.Center)
      .lineHeight(24)
      .fontColor('#333')
      .padding(10)
      .backgroundColor('#FFF3E0')
      .borderRadius(8)

    Button('å¤ªæ£’äº†ï¼')
      .width('80%')
      .type(ButtonType.Capsule)
      .backgroundColor('#FF6B35')
      .onClick(() => {
        this.achievementDialogController.close()
      })
  }
  .width('100%')
  .padding(30)
  .backgroundColor(Color.White)
  .borderRadius(20)
  .shadow({ radius: 20, color: '#1F000000', offsetY: 8 })
  }
  @Builder DeleteConfirmDialog() { Column({ space: 20 }) {
    Text('âš ï¸')
      .fontSize(48)
      .fontColor('#FF4444')

    Text('ç¡®è®¤åˆ é™¤')
      .fontSize(22)
      .fontWeight(FontWeight.Bold)

    Text('ä½ ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹ æƒ¯å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')
      .fontSize(16)
      .textAlign(TextAlign.Center)
      .fontColor('#666')
      .lineHeight(22)

    Row({ space: 20 }) {
      Button('å–æ¶ˆ')
        .layoutWeight(1)
        .backgroundColor('#F5F5F5')
        .fontColor('#333')
        .onClick(() => {
          this.deleteDialogController.close();
        })

      Button('ç¡®è®¤åˆ é™¤')
        .layoutWeight(1)
        .type(ButtonType.Capsule)
        .backgroundColor('#FF4444')
        .onClick(() => {
          if (this.habitToDeleteId !== -1) {
            this.deleteHabit(this.habitToDeleteId);
          }
          this.deleteDialogController.close();
        })
    }
    .width('100%')
  }
  .padding(30)
  }
  @Builder StatsCard() { Row({ space: 20 }) {
    // æ€»å¤©æ•°ç»Ÿè®¡
    Column({ space: 5 }) {
      Text(`${this.totalDays}`)
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FF6B35')

      Text('æ€»åšæŒå¤©æ•°')
        .fontSize(12)
        .fontColor('#666')
    }
    .layoutWeight(1)

    // åˆ†éš”çº¿
    Divider()
      .vertical(true)
      .height(40)
      .color('#E0E0E0')

    // ä¹ æƒ¯æ•°é‡
    Column({ space: 5 }) {
      Text(`${this.habits.length}`)
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor('#4CAF50')

      Text('è¿½è¸ªä¹ æƒ¯')
        .fontSize(12)
        .fontColor('#666')
    }
    .layoutWeight(1)

    // åˆ†éš”çº¿
    Divider()
      .vertical(true)
      .height(40)
      .color('#E0E0E0')

    // æˆåŠŸç‡
    Column({ space: 5 }) {
      Text(`${this.todayProgress}%`)
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor('#2196F3')

      Text('å½“å‰æˆåŠŸç‡')
        .fontSize(12)
        .fontColor('#666')
    }
    .layoutWeight(1)
  }
  .width('90%')
  .height(80)
  .padding(20)
  .backgroundColor(Color.White)
  .borderRadius(15)
  .shadow({ radius: 8, color: '#1F000000', offsetY: 4 })
  .margin({ top: 20, bottom: 20 })
  }

  // 2. ä¸ºå¯¼èˆªæ çš„æ¯ä¸ªæŒ‰é’®åˆ›å»ºä¸€ä¸ªBuilder
  @Builder
  TabButton(title: string, index: number, icon: Resource) {
    Column({space: 4}) {
      // è¿™é‡Œå¯ä»¥æ”¾å›¾æ ‡
      Image(icon)
        .width(20)   // å›¾æ ‡å¤§å°
        .height(20)
        .fillColor(this.currentTabIndex === index ? '#FF6B35' : '#999')
      Text(title)
        .fontColor(this.currentTabIndex === index ? '#FF6B35' : '#999')
        .fontSize(14)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  // 3. å°†åŸæœ‰çš„é¦–é¡µUIå†…å®¹å°è£…åˆ°ä¸€ä¸ªBuilderä¸­
  @Builder
  HomePageContent() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      Button({ type: ButtonType.Circle }) {
        Text('+').fontSize(24).fontColor(Color.White).fontWeight(FontWeight.Bold)
      }
      .width(60).height(60).backgroundColor('#FF6B35')
      .shadow({ radius: 15, color: '#40FF6B35', offsetY: 6 })
      .onClick(() => { this.dialogController.open(); })
      .zIndex(999).margin({ right: 20, bottom: 20 })

      Column() {
        Column({ space: 10 }) {
          Text('ä»Šå¤©ä½ "æ²¡åš"ä»€ä¹ˆï¼Ÿ').fontSize(28).fontWeight(FontWeight.Bold).fontColor('#333').textAlign(TextAlign.Center)
          Text('åšæŒå°±æ˜¯èƒœåˆ© ğŸ’ª').fontSize(16).fontColor('#666').textAlign(TextAlign.Center)
        }.width('100%').padding({ top: 40, bottom: 10 })

        this.StatsCard()

        if (this.habits.length > 0) {
          List({ space: 15, initialIndex: 0 }) {
            ForEach(this.habits, (habit: AntiHabit, index: number) => {
              ListItem() {
                Stack({ alignContent: Alignment.TopEnd }) {
                  Column() {
                    Row({ space: 15 }) {
                      Text(this.getBadgeText(this.habitDays[index] || 0))
                        .fontSize(24).width(50).height(50).textAlign(TextAlign.Center).backgroundColor('#F8F9FA').borderRadius(25)
                        .border({ width: 2, color: this.getDaysColor(this.habitDays[index] || 0) })
                      Column({ space: 5 }) {
                        Text(habit.name).fontSize(18).fontWeight(FontWeight.Medium).fontColor('#333').maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
                        Text(`å·²åšæŒ ${this.habitDays[index] || 0} å¤©`).fontSize(14).fontColor('#666')
                      }.alignItems(HorizontalAlign.Start).layoutWeight(1)
                      Text(`${this.habitDays[index] || 0}`)
                        .fontSize(24).fontWeight(FontWeight.Bold).fontColor(this.getDaysColor(this.habitDays[index] || 0))
                    }
                    .width('100%').padding({ top: 20, left: 20, right: 20, bottom: 15 })
                    .onClick(() => {
                      if (!this.context) return;
                      const habitData = this.habits[index].toJSON();
                      router.pushUrl({
                        url: 'pages/HabitDetailPage',
                        params: { habit: habitData }
                      }, (err) => { if (err) console.error('è·³è½¬å¤±è´¥:', err); })
                    })
                    Button('æˆ‘å¤±è´¥äº† ğŸ˜”', { type: ButtonType.Capsule })
                      .width('70%').height(40).backgroundColor('#FF5252').fontColor(Color.White).fontSize(14).margin({ bottom: 20 })
                      .onClick(() => { this.resetHabit(habit.id); })
                  }
                  .width('100%').backgroundColor(Color.White).borderRadius(15)
                  .shadow({ radius: 8, color: '#1A000000', offsetX: 0, offsetY: 4 })
                  .alignItems(HorizontalAlign.Center)
                  Button({ type: ButtonType.Circle }) { Text('Ã—').fontSize(18).fontColor('#999') }
                    .width(20).height(20).backgroundColor('#F5F5F5')
                    .onClick(() => { this.habitToDeleteId = habit.id; this.deleteDialogController.open(); })
                    .margin({ top: 10, right: 10 })
                }
              }
            }, (habit: AntiHabit, index: number) => habit.id.toString())  // æŒ‡å®šå”¯ä¸€çš„key
          }.width('90%').layoutWeight(1).edgeEffect(EdgeEffect.Spring).scrollBar(BarState.Off)   // å…³é—­æ»šåŠ¨æ¡
        } else {
          Column({ space: 20 }) {
            Text('ğŸ“').fontSize(64).opacity(0.5)
            Text('è¿˜æ²¡æœ‰è¿½è¸ªä»»ä½•ä¹ æƒ¯').fontSize(18).fontColor('#999')
            Text('ç‚¹å‡»å³ä¸‹è§’çš„ + æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªä¹ æƒ¯å§ï¼').fontSize(14).fontColor('#BBB').textAlign(TextAlign.Center)
          }.layoutWeight(1).justifyContent(FlexAlign.Center)
        }
      }.width('100%').height('100%').alignItems(HorizontalAlign.Center)
    }.width('100%').height('100%').backgroundColor('#F8F9FA')
  }

  build() {
    // 4. ä½¿ç”¨Tabsä½œä¸ºæ ¹ç»„ä»¶
    Tabs({ barPosition: BarPosition.End }) {
      TabContent() {
        this.HomePageContent() // è°ƒç”¨Builderæ˜¾ç¤ºé¦–é¡µå†…å®¹
      }.tabBar(this.TabButton('é¦–é¡µ', 0, $r('app.media.ic_shouye')))

      TabContent() {
        RecordsPage()
      }.tabBar(this.TabButton('è®°å½•', 1, $r('app.media.ic_jilu')))

      TabContent() {
        ProfilePage()
      }.tabBar(this.TabButton('æˆ‘çš„', 2, $r('app.media.ic_wode')))
    }
    .onChange((index: number) => {
      this.currentTabIndex = index;
    })
    .width('100%')
    .height('100%')
  }
}