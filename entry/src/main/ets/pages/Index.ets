// import { AntiHabit } from '../model/AntiHabit';
// import { calculateDaysBetween } from '../util/DateUtil';
// import { AddHabitDialog } from '../view/AddHabitDialog';
// import { habitStorage } from '../util/HabitStorage';
// import common from '@ohos.app.ability.common';
// import { achievementService } from '../util/AchievementService';
// import router from '@ohos.router';
//
// interface AchievementDialogParams {
//   names: string[];
// }
//
// @Entry
// @Component
// struct Index {
//   @State habits: AntiHabit[] = [];
//   @State habitToDeleteIndex: number = -1;
//   @State newAchievementNames: string[] = [];
//
//   private context: common.UIAbilityContext | null = null;
//
//   private deleteDialogController: CustomDialogController = new CustomDialogController({
//     builder: this.DeleteConfirmDialog,
//     autoCancel: true
//   });
//
//   private achievementDialogController: CustomDialogController = new CustomDialogController({
//     builder: () => {
//       this.AchievementUnlockedDialog({ names: this.newAchievementNames })
//     },
//     autoCancel: true,
//     alignment: DialogAlignment.Center
//   });
//
//   @Builder
//   private buildAddHabitDialog() {
//     AddHabitDialog({
//       controller: this.dialogController,
//       onConfirm: (name: string) => {
//         this.addNewHabit(name);
//       }
//     })
//   }
//
//   private dialogController: CustomDialogController = new CustomDialogController({
//     builder: this.buildAddHabitDialog,
//     autoCancel: true,
//     alignment: DialogAlignment.Center
//   });
//
//   onPageShow() {
//     this.context = getContext(this) as common.UIAbilityContext;
//     habitStorage.loadHabits(this.context).then(loadedHabits => {
//       let anyChange = false;
//       let allNewNames: string[] = [];
//
//       loadedHabits.forEach(habit => {
//         const newlyUnlocked = achievementService.checkAndUnlock(habit);
//         if (newlyUnlocked.length > 0) {
//           anyChange = true;
//           allNewNames.push(...newlyUnlocked);
//         }
//       });
//
//       this.habits = loadedHabits;
//
//       if (anyChange) {
//         this.newAchievementNames = allNewNames;
//         this.achievementDialogController.open();
//         if (this.context) {
//           habitStorage.saveHabits(this.context, this.habits);
//         }
//       }
//     })
//   }
//
//   async resetHabit(index: number) {
//     if (!this.context) return;
//     const oldHabit = this.habits[index];
//     const updatedHabit = new AntiHabit(oldHabit.id, oldHabit.name, new Date(), []);
//     this.habits[index] = updatedHabit;
//     await habitStorage.saveHabits(this.context, this.habits);
//   }
//
//   async addNewHabit(name: string) {
//     if (!this.context) return;
//     const newId = new Date().getTime();
//     const newHabit = new AntiHabit(newId, name, new Date());
//     this.habits.unshift(newHabit);
//     await habitStorage.saveHabits(this.context, this.habits);
//   }
//
//   async deleteHabit(index: number) {
//     if (!this.context || index < 0 || index >= this.habits.length) {
//       return;
//     }
//     this.habits.splice(index, 1);
//     await habitStorage.saveHabits(this.context, this.habits);
//   }
//
//   @Builder AchievementUnlockedDialog(params: AchievementDialogParams) {
//     Column({ space: 20 }) {
//       Text('æ­å–œï¼')
//         .fontSize(24).fontWeight(FontWeight.Bold)
//       Text(`ä½ è§£é”äº†æ–°çš„æˆå°±ï¼š\n${params.names.join('ã€')}`)
//         .fontSize(18)
//         .textAlign(TextAlign.Center)
//         .lineHeight(24)
//       Button('å¤ªæ£’äº†ï¼')
//         .width('80%')
//         .type(ButtonType.Capsule)
//         .onClick(() => {
//           this.achievementDialogController.close()
//         })
//     }.width('80%').padding(25).backgroundColor(Color.White).borderRadius(20)
//   }
//
//   @Builder DeleteConfirmDialog() {
//     Column({ space: 20 }) {
//       Text('ç¡®è®¤åˆ é™¤')
//         .fontSize(22).fontWeight(FontWeight.Bold)
//       Text('ä½ ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹ æƒ¯å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')
//         .fontSize(16).textAlign(TextAlign.Center).fontColor(Color.Gray)
//       Row({ space: 15 }) {
//         Button('å–æ¶ˆ')
//           .layoutWeight(1)
//           .onClick(() => {
//             this.deleteDialogController.close();
//           })
//         Button('ç¡®è®¤åˆ é™¤')
//           .layoutWeight(1)
//           .type(ButtonType.Capsule)
//           .backgroundColor('#ff4d4f')
//           .onClick(() => {
//             if (this.habitToDeleteIndex !== -1) {
//               this.deleteHabit(this.habitToDeleteIndex);
//             }
//             this.deleteDialogController.close();
//           })
//       }
//       .width('100%')
//     }
//     .width('80%')
//     .padding(25)
//     .backgroundColor(Color.White)
//     .borderRadius(20)
//   }
//
//   build() {
//     Stack({alignContent: Alignment.BottomEnd}) {
//       // æ‚¬æµ®æ·»åŠ æŒ‰é’®å›ºå®šåˆ°é¡µé¢å³ä¸‹è§’
//       Button({ type: ButtonType.ROUNDED_RECTANGLE }) {
//         Image($r('app.media.built'))
//           .width(30)
//           .height(30)
//           .fillColor(Color.White)
//
//       }
//       .width(56)
//       .height(56)
//       .backgroundColor('#ffffffff')
//       .shadow({ radius: 10, color: '#1F000000' })
//       .onClick(() => {
//         this.dialogController.open();
//       })
//       .zIndex(999) // ç¡®ä¿æŒ‰é’®å±‚çº§é«˜äºæ»šåŠ¨å†…å®¹
//       .align(Alignment.Center) // å…³é”®ï¼šå›ºå®šåˆ°å³ä¸‹è§’
//       .margin({ right: '5%', bottom: '5%' }) // ç¦»è¾¹æ¡† 20px
//
//       Column() {
//         Text('ä»Šå¤©ä½ â€œæ²¡åšâ€ä»€ä¹ˆï¼Ÿ')
//           .fontSize(30)
//           .fontWeight(FontWeight.Bold)
//           .width('100%')
//           .textAlign(TextAlign.Center)
//           .padding({ top: 40, bottom: 20 })
//
//         List({ space: 12, initialIndex: 0 }) {
//           ForEach(this.habits, (habit: AntiHabit, index: number) => {
//             ListItem() {
//               Stack({alignContent: Alignment.BottomEnd}) {
//                 // ç™½è‰²å¡ç‰‡å†…å®¹
//                 Column() {
//                   Row() {
//                     Text(habit.name)
//                       .fontSize(20)
//                       .layoutWeight(1)
//                     Text(`${calculateDaysBetween(habit.lastBreakDate, new Date())} å¤©`)
//                       .fontSize(24)
//                       .fontWeight(FontWeight.Bold)
//                       .fontColor('#3cba54')
//                   }
//                   .width('100%')
//                   .padding({ top: 20, left: 20, right: 20, bottom: 15 })
//                   .onClick(() => {
//                     if (!this.context) return;
//                     const habitData = this.habits[index].toJSON();
//                     this.getUIContext().getRouter().pushUrl({
//                       url: 'pages/AchievementPage',
//                       params: { habit: habitData }
//                     }, (err) => {
//                       if (err) console.error('è·³è½¬å¤±è´¥:', err);
//                     })
//                   })
//
//                   Button('æˆ‘å¤±è´¥äº†...', { type: ButtonType.Capsule })
//                     .width('60%')
//                     .height(40)
//                     .backgroundColor('#ffef4e4e')
//                     .fontColor(Color.White)
//                     .margin({ bottom: 15 })
//                     .onClick(() => {
//                       this.resetHabit(index);
//                     })
//                 }
//                 .width('100%')
//                 .backgroundColor(Color.White)
//                 .borderRadius(15)
//                 .shadow({ radius: 6, color: '#1F000000', offsetX: 2, offsetY: 4 })
//                 .alignItems(HorizontalAlign.Center)
//
//                 // åˆ é™¤æŒ‰é’®å›ºå®šåœ¨å¡ç‰‡å³ä¸Šè§’
//                 Image($r('app.media.ic_delete'))
//                   .width(28)
//                   .height(28)
//                   .fillColor(Color.Gray)
//                   .padding(8)
//                   .onClick(() => {
//                     this.habitToDeleteIndex = index;
//                     this.deleteDialogController.open();
//                   })
//                   .align(Alignment.Top) // å…³é”®ï¼šå¯¹é½åˆ°å³ä¸Šè§’
//                   .margin({ top: 7, right: 7 })
//               }
//             }
//           })
//         }
//         .width('100%')
//         .layoutWeight(1)
//         .edgeEffect(EdgeEffect.Spring)
//       }
//       .width('100%')
//       .height('100%')
//
//
//
//     }
//     .width('100%')
//     .height('100%')
//     .backgroundColor('#F1F3F5')
//
//
//   }
// }
import { AntiHabit } from '../model/AntiHabit';
import { calculateDaysBetween } from '../util/DateUtil';
import { AddHabitDialog } from '../view/AddHabitDialog';
import { habitStorage } from '../util/HabitStorage';
import common from '@ohos.app.ability.common';
import { achievementService } from '../util/AchievementService';
import router from '@ohos.router';

interface AchievementDialogParams {
  names: string[];
}

@Entry
@Component
struct Index {
  @State habits: AntiHabit[] = [];
  @State habitToDeleteIndex: number = -1;
  @State newAchievementNames: string[] = [];
  @State totalDays: number = 0; // æ–°å¢ï¼šæ€»å¤©æ•°ç»Ÿè®¡
  @State todayProgress: number = 0; // æ–°å¢ï¼šä»Šæ—¥è¿›åº¦

  private context: common.UIAbilityContext | null = null;

  private deleteDialogController: CustomDialogController = new CustomDialogController({
    builder: this.DeleteConfirmDialog,
    autoCancel: true
  });

  private achievementDialogController: CustomDialogController = new CustomDialogController({
    builder: () => {
      this.AchievementUnlockedDialog({ names: this.newAchievementNames })
    },
    autoCancel: true,
    alignment: DialogAlignment.Center
  });

  @Builder
  private buildAddHabitDialog() {
    AddHabitDialog({
      controller: this.dialogController,
      onConfirm: (name: string) => {
        this.addNewHabit(name);
      }
    })
  }

  private dialogController: CustomDialogController = new CustomDialogController({
    builder: this.buildAddHabitDialog,
    autoCancel: true,
    alignment: DialogAlignment.Center
  });

  // æ–°å¢ï¼šè®¡ç®—ç»Ÿè®¡æ•°æ®
  private calculateStats() {
    this.totalDays = this.habits.reduce((sum, habit) => {
      return sum + calculateDaysBetween(habit.lastBreakDate, new Date());
    }, 0);

    this.todayProgress = this.habits.length > 0 ?
    Math.round((this.habits.filter(h => calculateDaysBetween(h.lastBreakDate, new Date()) > 0).length / this.habits.length) * 100) : 0;
  }

  onPageShow() {
    this.context = getContext(this) as common.UIAbilityContext;
    habitStorage.loadHabits(this.context).then(loadedHabits => {
      let anyChange = false;
      let allNewNames: string[] = [];

      loadedHabits.forEach(habit => {
        const newlyUnlocked = achievementService.checkAndUnlock(habit);
        if (newlyUnlocked.length > 0) {
          anyChange = true;
          allNewNames.push(...newlyUnlocked);
        }
      });

      this.habits = loadedHabits;
      this.calculateStats(); // è®¡ç®—ç»Ÿè®¡æ•°æ®

      if (anyChange) {
        this.newAchievementNames = allNewNames;
        this.achievementDialogController.open();
        if (this.context) {
          habitStorage.saveHabits(this.context, this.habits);
        }
      }
    })
  }

  async resetHabit(index: number) {
    if (!this.context) return;
    const oldHabit = this.habits[index];
    const updatedHabit = new AntiHabit(oldHabit.id, oldHabit.name, new Date(), []);
    this.habits[index] = updatedHabit;
    await habitStorage.saveHabits(this.context, this.habits);
    this.calculateStats(); // é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®
  }

  async addNewHabit(name: string) {
    if (!this.context) return;
    const newId = new Date().getTime();
    const newHabit = new AntiHabit(newId, name, new Date());
    this.habits.unshift(newHabit);
    await habitStorage.saveHabits(this.context, this.habits);
    this.calculateStats(); // é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®
  }

  async deleteHabit(index: number) {
    if (!this.context || index < 0 || index >= this.habits.length) {
      return;
    }
    this.habits.splice(index, 1);
    await habitStorage.saveHabits(this.context, this.habits);
    this.calculateStats(); // é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®
  }

  // æ–°å¢ï¼šè·å–å¤©æ•°å¯¹åº”çš„é¢œè‰²
  private getDaysColor(days: number): string {
    if (days >= 30) return '#00C853'; // æ·±ç»¿è‰²
    if (days >= 14) return '#4CAF50'; // ç»¿è‰²
    if (days >= 7) return '#8BC34A';  // æµ…ç»¿è‰²
    if (days >= 3) return '#FFC107';  // é»„è‰²
    return '#FF5722'; // æ©™çº¢è‰²
  }

  // æ–°å¢ï¼šè·å–å¾½ç« æ–‡å­—
  private getBadgeText(days: number): string {
    if (days >= 30) return 'ğŸ’';
    if (days >= 14) return 'ğŸ†';
    if (days >= 7) return 'ğŸ¥‡';
    if (days >= 3) return 'ğŸ¥ˆ';
    return 'ğŸ¥‰';
  }

  @Builder AchievementUnlockedDialog(params: AchievementDialogParams) {
    Column({ space: 20 }) {
      // æ·»åŠ åŠ¨ç”»æ•ˆæœ
      Text('ğŸ‰')
        .fontSize(48)
        .animation({
          duration: 1000,
          curve: Curve.EaseInOut,
          iterations: -1,
          playMode: PlayMode.Alternate
        })

      Text('æ­å–œè§£é”æ–°æˆå°±ï¼')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FF6B35')

      Text(`${params.names.join('ã€')}`)
        .fontSize(18)
        .textAlign(TextAlign.Center)
        .lineHeight(24)
        .fontColor('#333')
        .padding(10)
        .backgroundColor('#FFF3E0')
        .borderRadius(8)

      Button('å¤ªæ£’äº†ï¼')
        .width('80%')
        .type(ButtonType.Capsule)
        .backgroundColor('#FF6B35')
        .onClick(() => {
          this.achievementDialogController.close()
        })
    }
    .width('85%')
    .padding(30)
    .backgroundColor(Color.White)
    .borderRadius(20)
    .shadow({ radius: 20, color: '#1F000000', offsetY: 8 })
  }

  @Builder DeleteConfirmDialog() {
    Column({ space: 20 }) {
      Text('âš ï¸')
        .fontSize(48)
        .fontColor('#FF4444')

      Text('ç¡®è®¤åˆ é™¤')
        .fontSize(22)
        .fontWeight(FontWeight.Bold)

      Text('ä½ ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹ æƒ¯å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')
        .fontSize(16)
        .textAlign(TextAlign.Center)
        .fontColor('#666')
        .lineHeight(22)

      Row({ space: 20 }) {
        Button('å–æ¶ˆ')
          .layoutWeight(1)
          .backgroundColor('#F5F5F5')
          .fontColor('#333')
          .onClick(() => {
            this.deleteDialogController.close();
          })

        Button('ç¡®è®¤åˆ é™¤')
          .layoutWeight(1)
          .type(ButtonType.Capsule)
          .backgroundColor('#FF4444')
          .onClick(() => {
            if (this.habitToDeleteIndex !== -1) {
              this.deleteHabit(this.habitToDeleteIndex);
            }
            this.deleteDialogController.close();
          })
      }
      .width('100%')
    }
    .padding(30)
  }

  // æ–°å¢ï¼šç»Ÿè®¡å¡ç‰‡Builder
  @Builder
  StatsCard() {
    Row({ space: 20 }) {
      // æ€»å¤©æ•°ç»Ÿè®¡
      Column({ space: 5 }) {
        Text(`${this.totalDays}`)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FF6B35')

        Text('æ€»åšæŒå¤©æ•°')
          .fontSize(12)
          .fontColor('#666')
      }
      .layoutWeight(1)

      // åˆ†éš”çº¿
      Divider()
        .vertical(true)
        .height(40)
        .color('#E0E0E0')

      // ä¹ æƒ¯æ•°é‡
      Column({ space: 5 }) {
        Text(`${this.habits.length}`)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#4CAF50')

        Text('è¿½è¸ªä¹ æƒ¯')
          .fontSize(12)
          .fontColor('#666')
      }
      .layoutWeight(1)

      // åˆ†éš”çº¿
      Divider()
        .vertical(true)
        .height(40)
        .color('#E0E0E0')

      // æˆåŠŸç‡
      Column({ space: 5 }) {
        Text(`${this.todayProgress}%`)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2196F3')

        Text('å½“å‰æˆåŠŸç‡')
          .fontSize(12)
          .fontColor('#666')
      }
      .layoutWeight(1)
    }
    .width('90%')
    .height(80)
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(15)
    .shadow({ radius: 8, color: '#1F000000', offsetY: 4 })
    .margin({ top: 20, bottom: 20 })
  }

  build() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      // æ”¹è¿›çš„æ‚¬æµ®æ·»åŠ æŒ‰é’®
      Button({ type: ButtonType.Circle }) {
        Text('+')
          .fontSize(24)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Bold)
      }
      .width(60)
      .height(60)
      .backgroundColor('#FF6B35')
      .shadow({
        radius: 15,
        color: '#40FF6B35',
        offsetY: 6
      })
      .onClick(() => {
        this.dialogController.open();
      })
      .zIndex(999)
      .margin({ right: 20, bottom: 100 })

      Column() {
        // æ”¹è¿›çš„æ ‡é¢˜åŒºåŸŸ
        Column({ space: 10 }) {
          Text('ä»Šå¤©ä½ "æ²¡åš"ä»€ä¹ˆï¼Ÿ')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .textAlign(TextAlign.Center)

          Text('åšæŒå°±æ˜¯èƒœåˆ© ğŸ’ª')
            .fontSize(16)
            .fontColor('#666')
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .padding({ top: 40, bottom: 10 })

        // æ–°å¢ï¼šç»Ÿè®¡å¡ç‰‡
        this.StatsCard()

        // æ”¹è¿›çš„ä¹ æƒ¯åˆ—è¡¨
        if (this.habits.length > 0) {
          List({ space: 15, initialIndex: 0 }) {
            ForEach(this.habits, (habit: AntiHabit, index: number) => {
              ListItem() {
                Stack({ alignContent: Alignment.TopEnd }) {
                  // æ”¹è¿›çš„å¡ç‰‡è®¾è®¡
                  Column() {
                    Row({ space: 15 }) {
                      // å·¦ä¾§å¾½ç« 
                      Text(this.getBadgeText(calculateDaysBetween(habit.lastBreakDate, new Date())))
                        .fontSize(24)
                        .width(50)
                        .height(50)
                        .textAlign(TextAlign.Center)
                        .backgroundColor('#F8F9FA')
                        .borderRadius(25)
                        .border({
                          width: 2,
                          color: this.getDaysColor(calculateDaysBetween(habit.lastBreakDate, new Date()))
                        })

                      // ä¸­é—´å†…å®¹
                      Column({ space: 5 }) {
                        Text(habit.name)
                          .fontSize(18)
                          .fontWeight(FontWeight.Medium)
                          .fontColor('#333')
                          .maxLines(1)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })

                        Text(`å·²åšæŒ ${calculateDaysBetween(habit.lastBreakDate, new Date())} å¤©`)
                          .fontSize(14)
                          .fontColor('#666')
                      }
                      .alignItems(HorizontalAlign.Start)
                      .layoutWeight(1)

                      // å³ä¾§å¤©æ•°æ˜¾ç¤º
                      Text(`${calculateDaysBetween(habit.lastBreakDate, new Date())}`)
                        .fontSize(24)
                        .fontWeight(FontWeight.Bold)
                        .fontColor(this.getDaysColor(calculateDaysBetween(habit.lastBreakDate, new Date())))
                    }
                    .width('100%')
                    .padding({ top: 20, left: 20, right: 20, bottom: 15 })
                    .onClick(() => {
                      if (!this.context) return;
                      const habitData = this.habits[index].toJSON();
                      this.getUIContext().getRouter().pushUrl({
                        url: 'pages/AchievementPage',
                        params: { habit: habitData }
                      }, (err) => {
                        if (err) console.error('è·³è½¬å¤±è´¥:', err);
                      })
                    })

                    // æ”¹è¿›çš„å¤±è´¥æŒ‰é’®
                    Button('æˆ‘å¤±è´¥äº† ğŸ˜”', { type: ButtonType.Capsule })
                      .width('70%')
                      .height(40)
                      .backgroundColor('#FF5252')
                      .fontColor(Color.White)
                      .fontSize(14)
                      .margin({ bottom: 20 })
                      .onClick(() => {
                        this.resetHabit(index);
                      })
                  }
                  .width('100%')
                  .backgroundColor(Color.White)
                  .borderRadius(15)
                  .shadow({
                    radius: 8,
                    color: '#1A000000',
                    offsetX: 0,
                    offsetY: 4
                  })
                  .alignItems(HorizontalAlign.Center)

                  // æ”¹è¿›çš„åˆ é™¤æŒ‰é’®
                  Button({ type: ButtonType.Circle }) {
                    Text('Ã—')
                      .fontSize(18)
                      .fontColor('#999')
                  }
                  .width(20)
                  .height(20)
                  .backgroundColor('#F5F5F5')
                  .onClick(() => {
                    this.habitToDeleteIndex = index;
                    this.deleteDialogController.open();
                  })
                  .margin({ top: 10, right: 10 })
                }
              }
            })
          }
          .width('90%')
          .layoutWeight(1)
          .edgeEffect(EdgeEffect.Spring)
        } else {
          // ç©ºçŠ¶æ€æ˜¾ç¤º
          Column({ space: 20 }) {
            Text('ğŸ“')
              .fontSize(64)
              .opacity(0.5)

            Text('è¿˜æ²¡æœ‰è¿½è¸ªä»»ä½•ä¹ æƒ¯')
              .fontSize(18)
              .fontColor('#999')

            Text('ç‚¹å‡»å³ä¸‹è§’çš„ + æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªä¹ æƒ¯å§ï¼')
              .fontSize(14)
              .fontColor('#BBB')
              .textAlign(TextAlign.Center)
          }
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .height('100%')
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }
}